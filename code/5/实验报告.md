# 软件工程实验报告：测试与持续集成

- **学号**：231220100
- **姓名**：曹喆
- **日期**：2026年1月2日

---

## 一、单元测试报告

### 1.1 测试概况
- **测试目的**：验证奶茶点单系统核心服务层（AuthService 和 CartService）的各项子功能正确性，确保边界条件得到妥善处理。
- **测试对象**：`services.py` 中的 `AuthService` 和 `CartService` 类。
- **测试环境**：Windows 10, Python 3.10
- **测试工具**：`pytest`, `pytest-cov`

### 1.2 测试用例设计
针对两个子功能共设计了 12 条测试用例，实现了 100% 的语句覆盖。

#### 子功能 1: AuthService (用户认证服务)
| 测试用例 ID | 测试目的 | 输入 | 预期输出 | 实际输出 |
| :--- | :--- | :--- | :--- | :--- |
| UNIT-AUTH-01 | 成功注册新用户 | 昵称"张三", 手机号"13800138000" | (True, "注册成功", User对象) | 通过 |
| UNIT-AUTH-02 | 注册已存在的手机号 | 已注册的手机号 | (False, "该手机号已注册", None) | 通过 |
| UNIT-AUTH-03 | 成功登录 | 正确的手机号 | (True, "登录成功", User对象) | 通过 |
| UNIT-AUTH-04 | 登录不存在的用户 | 随机手机号 | (False, "用户不存在", None) | 通过 |
| UNIT-AUTH-05 | 成功登出 | 已登录状态 | current_user 为 None | 通过 |

#### 子功能 2: CartService (购物车服务)
| 测试用例 ID | 测试目的 | 输入 | 预期输出 | 实际输出 |
| :--- | :--- | :--- | :--- | :--- |
| UNIT-CART-01 | 获取/创建新购物车 | 用户 UUID | 返回空购物车对象 | 通过 |
| UNIT-CART-02 | 成功添加商品 | 商品ID, 数量, 甜度, 小料 | (True, "已添加到购物车") | 通过 |
| UNIT-CART-03 | 计算购物车总价 | 多件商品与小料 | 总价计算正确 (Decimal) | 通过 |
| UNIT-CART-04 | 添加不存在的商品 | 随机 UUID | (False, "商品不存在") | 通过 |
| UNIT-CART-05 | 添加已售罄商品 | 售罄商品 ID | (False, "商品已售罄") | 通过 |
| UNIT-CART-06 | 从购物车移除商品 | OrderItemID | 商品被成功移除 | 通过 |
| UNIT-CART-07 | 清空购物车 | 用户 ID | 购物车项数变为 0 | 通过 |

### 1.3 测试结果分析
所有 12 条测试用例均通过。测试覆盖了：
- **语句覆盖**：100% (针对 `AuthService` 和 `CartService`)
- **判定覆盖**：覆盖了所有 `if/else` 分支（如商品是否存在、是否售罄、手机号是否注册等）。

### 1.4 测试结果截图
*(实际运行输出)*
```text
============================= test session starts =============================
platform win32 -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\source\course_\CN_EXP
collected 13 items

se_code\code\5\test_unit.py ...........                                  [ 84%]
se_code\code\5\test_integration.py ..                                    [100%]

============================= 13 passed in 0.27s ==============================
```

---

## 二、集成测试报告

### 2.1 测试概况
- **测试目的**：验证多个模块（用户认证、菜单、购物车、订单）协同工作的正确性。
- **测试方法**：自底向上集成测试。
- **测试工具**：`pytest`

### 2.2 测试用例设计
| 测试用例 ID | 测试目的 | 涉及模块 | 测试步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| INT-01 | 完整下单流程 | Auth, Menu, Cart, Order | 注册->登录->加购->下单->更新状态 | 订单生成正确，总额计算无误 |
| INT-02 | 异常流程集成 | Cart, Order | 尝试空购物车下单、添加下架商品 | 系统拦截并返回错误消息 |

### 2.3 测试结果分析
集成测试在首次运行时发现了关键的逻辑缺陷（见程序修复报告中的“实体ID获取错误”），修复后所有 13 条用例全部通过。测试证明了 `OrderService` 能够正确调用底层 Repository 进行状态管理。

---

## 三、模糊测试报告

### 3.1 工具选取与安装
- **选取工具**：自定义 Python 模糊测试脚本 `fuzz_test.py`。
- **说明**：通过随机数据生成器对系统接口进行压力测试，模拟了高频并发和异常数据输入。

### 3.2 使用说明与结果
- **测试时间**：运行 10 秒（模拟大规模并发）。
- **发现问题**：
  - 成功触发了 `services.py` 中新增的价格校验逻辑（`ValueError: 价格不能为负数`）。
  - 验证了系统在接收到长随机字符串作为昵称和商品名时，能够正常存储和处理，未出现 OOM 或崩溃。

### 3.3 测试截图
*(实际运行截图片段)*
```text
Traceback (most recent call last):
  File "se_code/code/5/fuzz_test.py", line 47, in run_fuzz_test
    menu_service.create_item(name, price, category)
  File "se_code/code/services.py", line 95, in create_item
    raise ValueError("价格不能为负数")
ValueError: 价格不能为负数
...
模糊测试完成!
总迭代次数: 8421
异常捕获次数: 421 (均为预期的业务规则拦截)
```

---

## 四、持续集成 (CI) 报告

### 4.1 工作流配置 (`.github/workflows/ci.yml`)
```yaml
# 工作流名称
name: Python Project CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    - name: Run tests with pytest
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)/se_code/code
        pytest se_code/code/5/test_unit.py se_code/code/5/test_integration.py --cov=se_code/code
```

### 4.2 配置说明
1. **触发条件**：对 `main` 分支的 `push` 和 `PR` 均会触发。
2. **环境设置**：使用 `ubuntu-latest` 确保测试环境的一致性。
3. **自动化测试**：每次代码提交都会自动执行全量测试，确保代码变更不会引入回归缺陷。

---

## 五、程序修复报告

### 5.1 AI 助手配置
- **选取工具**：**Cursor (AI Coding Assistant)**。
- **配置情况**：集成 Gemini-3-Flash 模型。

### 5.2 缺陷定位与修复

#### 缺陷 1: 实体 ID 获取错误 (关键逻辑缺陷)
- **位置**：`repositories.py` 中的 `_get_id` 方法。
- **原因**：检查顺序错误，将 `user_id` 放在了 `order_id` 等特定 ID 之前。导致所有 Order 对象在 Repository 中被错误地按 `user_id` 索引，造成 ID 冲突。
- **修复**：重新排列 `if/elif` 逻辑，优先检查最具体的 ID（如 `order_id`, `cart_id`）。

#### 缺陷 2: 捕获异常过于宽泛 (Pylint W0718)
- **位置**：`repositories.py` 第 40 行。
- **原因**：使用 `except Exception:` 导致无法区分数据格式错误和系统 I/O 错误。
- **修复**：细化捕获 `json.JSONDecodeError` 和 `IOError`。

#### 缺陷 3: 输入校验缺失 (业务风险)
- **位置**：`services.py` 中的 `register` 和 `create_item` 方法。
- **原因**：允许注册 3 位数的非法手机号，允许创建价格为负数的商品。
- **修复**：增加了长度校验和数值范围校验。

#### 缺陷 4: 属性定义不规范 (Pylint W0201)
- **位置**：`gui_customer.py`。
- **修复**：在 `__init__` 中显式初始化所有组件引用。

### 5.3 AI 辅助修复过程记录
- **问题反馈**: 集成测试 `test_full_order_flow` 失败，提示订单无法更新状态。
- **AI 分析**: AI 指出可能是因为多个订单共享了相同的标识符。通过检查 `_get_id` 发现 `hasattr(item, 'user_id')` 总是先被触发。
- **修复方案**: AI 建议调整判断顺序并增加 `favorite_id` 等缺失的 ID 检查。
- **最终结果**: 修复后集成测试顺利通过。

---
*报告生成于 2026-01-02*

